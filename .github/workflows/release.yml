name: Release & Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (e.g., v0.2.4)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  check-bump:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
      TARGET_BRANCH: ${{ github.event.release.target_commitish || github.event.repository.default_branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Verify bump before release
        run: |
          if [ -z "${RELEASE_TAG}" ]; then
            echo "release_tag is required for manual runs."
            exit 1
          fi
          git fetch origin "${TARGET_BRANCH}"
          release_version="$(grep '^version=' gradle.properties | cut -d= -f2)"
          if [ -z "${release_version}" ]; then
            echo "Could not read release version from gradle.properties."
            exit 1
          fi
          current_version="$(git show "origin/${TARGET_BRANCH}:gradle.properties" | grep '^version=' | cut -d= -f2)"
          if [ -z "${current_version}" ]; then
            echo "Could not read current version from ${TARGET_BRANCH}."
            exit 1
          fi
          if [ "${current_version}" = "${release_version}" ]; then
            echo "Bump is missing: ${TARGET_BRANCH} is still ${current_version} (release ${release_version})."
            exit 1
          fi
          echo "Bump verified: ${release_version} -> ${current_version}"

  publish-maven:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    needs: [check-bump]
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: 24
          distribution: temurin

      - name: Configure Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build, test, and publish to Maven Central
        run: ./gradlew clean publishAndReleaseToMavenCentral -PrunPluginValidation
        env:
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.MAVEN_CENTRAL_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.MAVEN_CENTRAL_SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

  publish-docs:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    needs: [check-bump]
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          check-latest: true

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '24'
          cache: gradle

      - name: Generate API reference
        run: ./gradlew dokkaGenerate

      - name: Install docs dependencies
        run: npm install

      - name: Build Antora site
        run: npm run docs:build

      - name: Deploy docs to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/site
          cname: tapik.akif.dev
