name: Release & Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (e.g., v0.2.4)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  check-bump:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
      TARGET_BRANCH: ${{ github.event.release.target_commitish || github.event.repository.default_branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Verify bump before release
        run: |
          if [ -z "${RELEASE_TAG}" ]; then
            echo "release_tag is required for manual runs."
            exit 1
          fi
          git fetch --tags origin
          release_version="${RELEASE_TAG#v}"
          file_version="$(grep '^version=' gradle.properties | cut -d= -f2)"
          if [ -z "${file_version}" ]; then
            echo "Could not read version from gradle.properties."
            exit 1
          fi
          if [ "${file_version}" != "${release_version}" ]; then
            echo "Release aborted: you likely forgot to run the version bump before cutting the release."
            echo "Expected gradle.properties version to match the release tag."
            echo "  Release tag: ${RELEASE_TAG}  (version ${release_version})"
            echo "  gradle.properties version: ${file_version}"
            echo "Example fix:"
            echo "  1) ./gradlew bumpVersion"
            echo "  2) commit the version changes"
            echo "  3) re-create the release tag (e.g., v${file_version})"
            exit 1
          fi
          latest_tag="$(git tag --list 'v*' --sort=-v:refname | grep -v "^${RELEASE_TAG}$" | head -n1)"
          if [ -n "${latest_tag}" ]; then
            latest_version="${latest_tag#v}"
            if [ "${latest_version}" = "${release_version}" ]; then
              echo "Release aborted: you likely forgot to run the version bump before cutting the release."
              echo "The release version matches the latest already-published version."
              echo "  Latest release tag: ${latest_tag}"
              echo "  New release tag:    ${RELEASE_TAG}"
              echo "Example fix:"
              echo "  1) ./gradlew bumpVersion"
              echo "  2) commit the version changes"
              echo "  3) re-create the release tag (e.g., v${file_version})"
              exit 1
            fi
          fi
          if [ "${latest_tag}" = "${RELEASE_TAG}" ]; then
            echo "Release aborted: you likely forgot to run the version bump before cutting the release."
            echo "The new release tag is identical to the latest release tag."
            echo "  Latest release tag: ${latest_tag}"
            echo "  New release tag:    ${RELEASE_TAG}"
            echo "Example fix:"
            echo "  1) ./gradlew bumpVersion"
            echo "  2) commit the version changes"
            echo "  3) re-create the release tag (e.g., v${file_version})"
            exit 1
          fi
          echo "Bump verified: ${latest_tag:-none} -> ${RELEASE_TAG}"

  generate-release-notes:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    needs: [check-bump]
    uses: ./.github/workflows/release-notes.yml
    with:
      end_ref: ${{ github.event.release.tag_name || inputs.release_tag }}

  publish-maven:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    needs: [check-bump]
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: 24
          distribution: temurin

      - name: Configure Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build, test, and publish to Maven Central
        run: ./gradlew clean publishAndReleaseToMavenCentral -PrunPluginValidation
        env:
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.MAVEN_CENTRAL_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.MAVEN_CENTRAL_SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

  publish-docs:
    if: github.event_name != 'release' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    needs: [check-bump]
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          check-latest: true

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '24'
          cache: gradle

      - name: Generate API reference
        run: ./gradlew dokkaGenerate

      - name: Install docs dependencies
        run: npm install

      - name: Build Antora site
        run: npm run docs:build

      - name: Deploy docs to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/site
          cname: tapik.akif.dev
